<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>App Genesis - AI App Builder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-html.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { background-color: #0f172a; color: #e2e8f0; height: 100vh; overflow: hidden; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        iframe { background: white; width: 100%; height: 100%; border: none; }
        .loader { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #3b82f6; width: 20px; height: 20px; -webkit-animation: spin 1s linear infinite; animation: spin 1s linear infinite; }
        @-webkit-keyframes spin { 0% { -webkit-transform: rotate(0deg); } 100% { -webkit-transform: rotate(360deg); } }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="flex flex-col h-screen">

    <header class="h-14 border-b border-slate-700 flex items-center justify-between px-4 bg-slate-900 z-10">
        <div class="flex items-center gap-2">
            <i class="fa-solid fa-microchip text-blue-500 text-xl"></i>
            <h1 class="font-bold text-lg tracking-wide">App Genesis <span class="text-xs bg-blue-600 px-2 py-0.5 rounded text-white font-normal">v1.0</span></h1>
        </div>
        <div class="flex items-center gap-3">
            <button onclick="toggleSettings()" class="text-slate-400 hover:text-white transition"><i class="fa-solid fa-gear"></i> API Key</button>
            <button onclick="downloadApp()" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded text-sm font-medium transition flex items-center gap-2">
                <i class="fa-solid fa-download"></i> Download App
            </button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        
        <div class="w-1/3 min-w-[350px] flex flex-col border-r border-slate-700 bg-slate-900 relative">
            
            <div id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-4 scrollbar-hide pb-20">
                <div class="bg-slate-800 p-3 rounded-lg border border-slate-700 text-sm">
                    <p class="text-slate-300">ðŸ‘‹ Welcome to App Genesis.</p>
                    <p class="mt-2 text-slate-400">I can build single-file HTML applications (HTML/CSS/JS) right here in your browser.</p> 
                    <p class="mt-2 text-blue-400">Example: "Create a Pomodoro timer with a dark theme and task list."</p>
                </div>
            </div>

            <div class="absolute bottom-0 w-full p-4 bg-slate-900 border-t border-slate-700">
                <div class="relative">
                    <textarea id="user-input" rows="2" class="w-full bg-slate-800 text-white rounded-lg pl-3 pr-12 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-600 resize-none" placeholder="Describe your app idea..."></textarea>
                    <button onclick="generateApp()" id="send-btn" class="absolute right-2 bottom-2 bg-blue-600 hover:bg-blue-700 text-white p-1.5 rounded-md transition">
                        <i class="fa-solid fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>

        <div class="flex-1 flex flex-col bg-slate-950 relative">
            
            <div class="h-10 bg-slate-900 border-b border-slate-700 flex items-center px-2">
                <button onclick="switchTab('preview')" id="tab-preview" class="px-4 py-2 text-sm text-blue-400 border-b-2 border-blue-400 font-medium">Preview</button>
                <button onclick="switchTab('code')" id="tab-code" class="px-4 py-2 text-sm text-slate-400 hover:text-white transition">Source Code</button>
                <div class="ml-auto text-xs text-slate-500" id="status-indicator">Ready</div>
            </div>

            <div class="relative flex-1 overflow-hidden">
                <div id="view-preview" class="w-full h-full block">
                    <iframe id="app-frame" sandbox="allow-scripts allow-modals allow-forms allow-popups"></iframe>
                </div>
                
                <div id="view-code" class="w-full h-full hidden overflow-auto bg-[#1e1e1e]">
                    <pre><code id="code-display" class="language-html"></code></pre>
                </div>
            </div>
        </div>
    </div>

    <div id="settings-modal" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center hidden">
        <div class="glass p-6 rounded-lg max-w-md w-full shadow-2xl">
            <h2 class="text-xl font-bold mb-2">Setup API Key</h2>
            <p class="text-sm text-slate-400 mb-4">This tool requires a Google Gemini API Key to generate code. Your key is stored locally in your browser and never sent to our servers.</p>
            
            <label class="block text-xs font-semibold uppercase text-slate-500 mb-1">Gemini API Key</label>
            <input type="password" id="api-key-input" class="w-full bg-slate-800 border border-slate-700 rounded p-2 text-white mb-4 focus:outline-none focus:border-blue-500">
            
            <div class="flex justify-end gap-2">
                <button onclick="toggleSettings()" class="px-4 py-2 rounded text-slate-300 hover:bg-slate-800 text-sm">Cancel</button>
                <button onclick="saveApiKey()" class="px-4 py-2 rounded bg-blue-600 hover:bg-blue-700 text-white text-sm">Save & Close</button>
            </div>
            <p class="text-xs text-slate-500 mt-4 text-center">Get a free key at <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-blue-400 underline">Google AI Studio</a></p>
        </div>
    </div>

    <script>
        // --- State Management ---
        let apiKey = localStorage.getItem('genesis_api_key') || '';
        let currentCode = '';
        let conversationHistory = [];

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            if (!apiKey) toggleSettings();
            
            // Load initial blank slate in iframe
            const frame = document.getElementById('app-frame');
            frame.srcdoc = `<body style="display:flex;justify-content:center;align-items:center;height:100vh;font-family:sans-serif;color:#555;">
                <div style="text-align:center;"><h2>No App Generated Yet</h2><p>Describe an idea on the left to begin.</p></div>
            </body>`;
        });

        // --- UI Functions ---
        function toggleSettings() {
            const modal = document.getElementById('settings-modal');
            modal.classList.toggle('hidden');
            if (!modal.classList.contains('hidden')) {
                document.getElementById('api-key-input').value = apiKey;
            }
        }

        function saveApiKey() {
            const input = document.getElementById('api-key-input').value.trim();
            if (input) {
                apiKey = input;
                localStorage.setItem('genesis_api_key', apiKey);
                toggleSettings();
                addMessage('system', 'API Key saved. You can now generate apps.');
            }
        }

        function switchTab(tab) {
            const previewBtn = document.getElementById('tab-preview');
            const codeBtn = document.getElementById('tab-code');
            const viewPreview = document.getElementById('view-preview');
            const viewCode = document.getElementById('view-code');

            if (tab === 'preview') {
                previewBtn.className = "px-4 py-2 text-sm text-blue-400 border-b-2 border-blue-400 font-medium";
                codeBtn.className = "px-4 py-2 text-sm text-slate-400 hover:text-white transition";
                viewPreview.classList.remove('hidden');
                viewCode.classList.add('hidden');
            } else {
                codeBtn.className = "px-4 py-2 text-sm text-blue-400 border-b-2 border-blue-400 font-medium";
                previewBtn.className = "px-4 py-2 text-sm text-slate-400 hover:text-white transition";
                viewCode.classList.remove('hidden');
                viewPreview.classList.add('hidden');
            }
        }

        function addMessage(role, text) {
            const container = document.getElementById('chat-container');
            const div = document.createElement('div');
            
            if (role === 'user') {
                div.className = "bg-blue-600/20 border border-blue-600/30 p-3 rounded-lg text-sm ml-4";
                div.innerHTML = `<p class="text-blue-100">${text}</p>`;
            } else {
                div.className = "bg-slate-800 border border-slate-700 p-3 rounded-lg text-sm mr-4";
                div.innerHTML = `<p class="text-slate-300">${text}</p>`;
            }
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        // --- Core Logic: AI Generation ---
        async function generateApp() {
            const input = document.getElementById('user-input');
            const prompt = input.value.trim();
            
            if (!prompt) return;
            if (!apiKey) { toggleSettings(); return; }

            // UI Updates
            addMessage('user', prompt);
            input.value = '';
            const status = document.getElementById('status-indicator');
            const sendBtn = document.getElementById('send-btn');
            
            status.innerHTML = '<div class="flex items-center gap-2 text-blue-400"><div class="loader"></div> Generating logic...</div>';
            sendBtn.disabled = true;
            sendBtn.classList.add('opacity-50');

            try {
                // Construct the System Prompt
                const systemPrompt = `
                    You are an expert Frontend Developer and UI/UX Designer. 
                    Your goal is to generate a SINGLE FILE HTML application (index.html) based on user requirements.
                    
                    RULES:
                    1. The output must be valid HTML5.
                    2. Include all CSS in a <style> tag or use TailwindCDN.
                    3. Include all JavaScript in a <script> tag.
                    4. DO NOT use external CSS/JS files (except CDNs like Tailwind, FontAwesome, React, Vue).
                    5. The app must be visually modern, aesthetic, and responsive.
                    6. The app must handle data using localStorage if persistence is needed.
                    7. If the user asks for changes, modify the existing code to implement them.
                    
                    CURRENT CONTEXT:
                    ${currentCode ? "This is an update to an existing app. Modify the code to satisfy the request." : "This is a brand new application request."}
                    
                    OUTPUT FORMAT:
                    Return ONLY the raw HTML code. Do not wrap in markdown blocks like \`\`\`html. just raw code.
                `;

                // Call Gemini API
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [
                            {
                                role: "user",
                                parts: [
                                    { text: systemPrompt },
                                    { text: `User Request: ${prompt}` },
                                    { text: `Current Code (if any): ${currentCode.substring(0, 10000)}` } // Limit context window
                                ]
                            }
                        ]
                    })
                });

                const data = await response.json();
                
                if (data.error) throw new Error(data.error.message);

                let rawText = data.candidates[0].content.parts[0].text;
                
                // Clean up markdown if the AI added it despite instructions
                rawText = rawText.replace(/```html/g, '').replace(/```/g, '');

                currentCode = rawText;
                
                // Render
                updatePreview(currentCode);
                addMessage('system', 'App generated successfully! Check the Preview tab.');

            } catch (error) {
                console.error(error);
                addMessage('system', `Error: ${error.message}`);
            } finally {
                status.innerText = 'Ready';
                sendBtn.disabled = false;
                sendBtn.classList.remove('opacity-50');
            }
        }

        function updatePreview(code) {
            // Update Iframe
            const frame = document.getElementById('app-frame');
            frame.srcdoc = code;

            // Update Code View
            const codeDisplay = document.getElementById('code-display');
            codeDisplay.textContent = code;
            Prism.highlightElement(codeDisplay);
        }

        function downloadApp() {
            if (!currentCode) {
                alert("Generate an app first!");
                return;
            }
            const blob = new Blob([currentCode], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'index.html';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Allow Enter key to send
        document.getElementById('user-input').addEventListener('keypress', function (e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                generateApp();
            }
        });

    </script>
</body>
</html>
